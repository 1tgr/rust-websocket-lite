language: minimal

services:
  - docker

before_script:
  - docker pull 1tgr/websocket-lite:${TRAVIS_BRANCH} || docker pull 1tgr/websocket-lite:master || true
  - docker pull 1tgr/websocket-lite:latest || true
  - docker build --target deps -t 1tgr/websocket-lite-deps .

script:
  - docker build --target app -t 1tgr/websocket-lite:latest . && docker-compose up --exit-code-from test
  - docker build --target fuzz -t 1tgr/websocket-lite-fuzz:latest . && docker run --cap-add SYS_PTRACE 1tgr/websocket-lite-fuzz:latest cargo fuzz run fuzz_codec fuzz/corpus/custom -- -dict=fuzz/dict.txt -max_total_time=60

after_script:
  - docker tag 1tgr/websocket-lite:latest 1tgr/websocket-lite:${TRAVIS_BRANCH}
  - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
  - docker push 1tgr/websocket-lite:latest
  - docker push 1tgr/websocket-lite:${TRAVIS_BRANCH}
